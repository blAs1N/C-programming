# 게임 엔진 아키텍처를 읽고 배운 것 (9장)

- 디버그 정보를 그리는 기능은 디버그에 많은 도움이 되기에 지원해야 한다.

  - 다음과 같은 간편하게 사용할 수 있는 기본 단위들을 지원해야 한다.
    - 선분
    - 구
    - 점 (픽셀 하나는 너무 작아서 작은 교차선이나 구로 나타낸다.)
    - 좌표계 축들
    - AABB, OBB 같은 경계 박스
    - 문자열
  
  - 다음과 같은 기능을 지원해야 한다.
    - 색 설정
    - 선분 굵기, 구의 반지름, 점의 크기 같은 크기 설정
    - 월드 공간과 스크린 공간 중 그릴 공간 선택
    - 깊이 테스트 설정
      - 깊이 테스트를 킬 경우 정상적인 물체에 가려질 수 있으나, 디버그 정보의 깊이를 확인할 수 있다.
      - 깊이 테스트를 끌 경우 보이지 않는 경우는 없으나, 정상적인 물체 위를 떠다니는 것처럼 보인다.
    - 어느 코드든지 디버그 API를 호출 할 수 있어야 한다. 대부분 렌더링 엔진은 게임 루프 내 특정 단계서만 기하 형상을 제출할 수 있기에, 보통 디버그 요청을 큐에 모았다가 나중에 처리한다.
    - 매 프레임마다 그릴 경우와 가끔 그릴 경우를 처리하기 위해 수명을 설정할 수 있어야 한다.

- 스크린샷이나 동영상을 찍을 수 있다면 디버그에 유용할 것이다. 스크린샷은 보통 비디오 메모리에서 주 메모리로 프레임 버프의 내용을 옮겨온 뒤에 이미지 파일로 변환한다.  
스크린샷도 다양한 선택이 있다.
  - 디버그 정보를 포함할지 여부
  - HUD를 포함할지 여부
  - 스크린샷의 해상도
  - 간단한 카메라 애니메이션

- 게임 엔진은 최적화를 위해서 프로파일링 툴을 제공할 필요가 있다. 프로파일링에는 2가지 방법이 있다.
  - 측정을 원하는 함수에 측정을 코드를 삽입해서 측정한다. 정확하고 구체적이지만, begin-end 방식일 경우 실수할 가능성이 있고, 느리다.
  - 일정 시간마다 Program Counter 등을 Sampling하여 코드 실행 빈도를 통계적으로 조사한다. 빠르지만, 정확한 측정이 불가능하다.

- 프로그램은 계층 구조를 이루기에 자신이 호출하는 함수를 포함한 (Inclusive) 시간과 자기 자신만의 (Exclusive) 시간만을 따로 재야한다.

- 메모리 역시 게임의 성능을 좌우하기에 메모리 (누수) 감지 툴이 필요하다. 다음은 메모리 프로파일러의 요구 사항이다.
  - 외부 API의 할당/해제도 관리해야 한다.
  - 메인 메모리 뿐 아니라 비디오 메모리 역시 관리해야 한다.
  - 다양한 할당자(5장 참조)를 사용한 할당/해제 역시 관리해야 한다.
  - 메모리가 적정 수준 이하로 떨어지거나 고갈된 경우를 알려줘야 한다.

- 이 책에서는 요구 사항만 나오고 구현에 관련된 내용이 없어 추가적으로 찾아보았습니다. 다음은 제가 조사한 내용으로. 언제나 피드백과 정보 제공은 환영합니다.

  1. GC와 프로파일러가 유사하다 생각하여 GC 알고리즘을 찾아보았고, 첫번째로 *Reference Counting Algorithm*을 발견했습니다. 그러나 이 알고리즘을 적용하기 위해서는 할당 API를 Wrapping해야 했기에, 커스텀 메모리 할당자를 제공하지 않는 외부 API를 지원할 수 없기에 다른 방법을 찾아보았습니다.

  2. 현재 GC에서 제일 많이 사용하는 알고리즘인 *Generation Algorithm*을 찾았습니다. (비디오 메모리 포함) 모든 메모리를 검사할 수 있다면 가능하지 않을까 생각했습니다. 그러나 이것은 GC 알고리즘일 뿐 메모리 프로파일링 알고리즘에 적용할 수 없어 다른 알고리즘을 찾아보기로 했습니다.

  3. 기준을 낮추어 커스텀 메모리 할당을 지원하는 외부 API만을 고려했습니다. 이 경우에는 5장에서 배운 커스텀 할당자를 사용해서 성능도 높이고, 관리도 가능하기에 최적의 방안이었습니다. 그러나 비디오 메모리랑 커스텀 메모리 할당을 지원하지 않는 외부 API는 지원할 수 없었습니다.

이 이상은 아직 찾지 못했습니다. 피드백과 정보 제공은 환영합니다.
