# 게임 엔진 아키텍처를 읽고 배운 점 (12장)

- 충돌 검출 시스템
  - 충돌 시스템은 충돌 여부 뿐만 아니라 의미있는 접촉 정보도 제공한다.

  - 물체의 충돌을 확인하려면 월드에 존재하는 형상, 위치, 방향 정보가 있어야 한다. 쉬운 판별을 위해 단순한 형상(구, 캡슐, 박스 등)을 사용한다.

  - 충돌체를 관리하기 위한 싱글턴 자료 구조인 충돌 월드를 이용한다. 강체 시뮬레이션 역시 월드를 공유한다. 그래서 충돌/물리 월드라고도 불리고, 물리 월드라고도 불린다.

  - 형상이란 경계에 의해 둘러싸인 안/밖이 있는 공간다. 지형, 강 등은 면으로 나타내는데, 3차원에서 면은 앞과 뒤는 있으나, 안과 밖은 없다. 그리고 얇은 면을 지날 때 충돌이 검출되지 않는 문제를 해결하기 위해 extrusion 값으로 두꺼움을 지정한다.

  - 볼록 형상은 형상 안에서 시작한 반직선이 표면을 한 번만 통과하는 성질을 가진 형상으로, 교차 검사가 오목 형상보다 단순하다는 장점이 있다.

  - 계산의 용이함을 위해 충돌 시스템은 한정된 종류의 형상만을 다루는데, 이를 충돌 기본 단위라고 한다.
    - 구 : 중심과 반지름으로 표현된다. 4차원 벡터로 표현해 SIMD를 이용할 수 있다.

    - 캡슐 : 캡슐의 끝 A와 B를 구가 이동할 때의 흔적을 나타내는 입체로서 표현되며, 두 점과 반지름 하나로 표현된다.

    - AABB : 좌표계의 축과 평행한 성질을 가진 직육면체이다. 좌표축을 기준으로 최소 좌표와 최대 좌표를 통해 표현한다. 교차 검사를 효율적으로 할 수 있으나, 항상 축 정렬 상태를 유지해야 한다.

    - OBB : AABB에 좌표축 기준 회전을 추가한 직육면체로, 반 너비, 반 깊이, 반 높이, 변환으로 나타낸다. (변환은 박스의 중심 좌표와 회전을 표현한다.)

    - DOP (Discrete Oriented Polytope) : AABB와 OBB를 일반화한 개념이다. 평면의 개수를 앞에 붙여서 k-DOP로 표현된다. ABB는 평면의 법선이 좌표축과 평행한 6-DOP이고, OBB는 평면의 법선이 물체의 좌표축과 평행한 6-DOP이다. 평면 식 k개 혹은 점 k와 법선 k개로 표현된다.

    - 다각형으로 이뤄진 임의 형상의 볼록 입체도 지원하며, 볼록한 다면체인지 검사하며 통과하면 k-DOP으로 변환된다.

    - 다각형(폴리곤) 수프 : 볼록하지 않은 임의의 형상을 지원할 때 쓰이며, 삼각형의 모임으로 표현된다. 지형 등을 표현할 때 쓰인다.
      - 충돌 검출 시 모든 삼각형을 검사해야하는 비효율성 때문에, 역학 시뮬레이션에 참가하지 않는 물체만 사용하게 제한하는 경우가 많다.

      - 볼록 형상이 아니기에 물체의 앞과 밖을 판별할 방법이 존재하지 않다. 이 때문에 다각형 수프는 삼각형 점점의 감기 방향으로 앞과 뒤를 판별한다.

    - 의자처럼 한 가지 형상으로 표현하는데 어려움이 있을 경우, 여러 형상을 합쳐 표현한다. 보통 복합 형상 전체 경계 볼륨 충돌 검사를 먼저 하여 성능 상 이득을 볼 수 있기에, 볼록 형상이 아닐 경우에도 복합 형상이 더 효율적인 경우가 많다.

    - 충돌 검사에는 해석 기하학을 이용한다.
      - 점이 구 안에 있는지 판별 : 구의 중심에서 점 좌표를 뺀 벡터의 크기가 반지름보다 크지 않으면 안에 있는 것이다.

      - 두 구가 교차하는지 판별 : 두 구의 중심을 잇는 벡터의 크기가 두 구의 반지름 합보다 크지 않으면 교차한 것이다.

      - 분할 축 정리 : 두 볼록 형상을 한 축에 투명했을 때 투영한 이미지들이 겹치지 않는 선이 존재하지 않으면 교차한다는 이론이다.
        - 투영된 이미지는 축 방향에서 최소, 최대 좌표로 볼 수 있다. 즉 C<sup>A</sup><sub>max</sub> < C<sup>B</sup><sub>min</sub>이거나 C<sup>B</sup><sub>max</sub> < C<sup>A</sup><sub>min</sub>이면 겹치지 않은 것이다.

        - 두 볼록 형상이 서로 교차하지 않을 경우, 중심을 연결하는 선분과 평행한 축은 올바른 분할 축이다.

      - 두 AABB의 충돌 검사는 분할 축 정리를 사용한다. AABB는 동일한 좌표축에 평행하므로 분할 축은 세 좌표축 중 하나이다. 즉 각 좌표축마다 최소, 최대 좌표를 검사하여 모든 구간이 겹치면 교차한 것이다.

      - GJK 알고리즘은 **볼록 형상들** 간 충돌 검출에 이용되며, 민코프스키 차라 하는 기하 연산을 바탕으로 한다.
        - 민코프스키 차는 형상 B의 내부에 존재하는 모든 점에서 형상 A의 내부에 존재하는 모든 점을 빼는 연산으로 결과는 집합 {(A<sub>i</sub> - B<sub>j</sub>)}이 된다.

        - 민코프스키 차를 볼록 형상에 적용할 경우, 형상이 교차할 경우에만 같은 좌표의 점이 존재하기에 원점을 포함한다.

        - 민코프스키 차를 통해 생성된 볼록 형상의 껍데기에 존재하는 점들로 구성된 사면체 중 원점을 둘러싸는 것을 찾을 수 있으면 교차하는 것이다.

        - 임의의 점에서 시작해서 원점에 가까운 정점을 포함하며 차수가 높은 단체를 만드는 것을 원점을 둘러쌀 때까지 반복한다. 현재의 단체보다 원점에 더 가까운 정점을 찾지 못하면 원점을 포함할 수 없다는 뜻이므로 교차하지 않는 것이다.

      - 형상 종류가 N개이면 짝지어 테스트해야 하므로 테스트의 방법은 O(N<sup>2</sup>)이다. 그렇기에 대부분의 충돌 엔진은 형상 종류를 제한한다.
        - 추가로 적절한 충돌 검사 함수를 호출하기 위해 더블 디스패치 시스템이 필요하다. 더블 디스패치를 구현하는 방법에는 2차원 함수 참조 테이블을 만드는 것과, 첫 객체에서 가상 함수를 호출하고, 여기서 두 번째 가상 함수를 호출하는 방식이 있다.
  
    - 움직이는 물체의 교차를 검사해야 할 경우, 매 프레임마다 자신보다 몇 배나 먼 거리를 움직일 경우, 프레임 간격이 이산적이기에 사이에 놓인 물체는 충돌을 감지하지 못하는 문제가 발생한다. 이를 **종이를 뚫는 총알 문제 (bullet through paper) 혹은 터널링 (tunneling)** 이라고 한다.
      - 스윕 형상으로 터널링을 해결할 수 있다. 정지 화면에서 교차 검사를 하는 대신, 전 프레임과 현 프레임으로 스윕 형상을 만들어 검사하는 것이다. 그러나 곡선으로 이동하거나, 회전할 경우 정확한 표현이 불가능하다.
        - 곡선 움직임 문제를 해결하는 방법으로는 곡선 경로를 따라 스윕 형상을 만들어야 한다. 그러나 곡선을 따라 만들 경우 볼록 형상이 아닐 수도 있기에 검사가 복잡해진다.

        - 회전을 해결하는 방법은 볼록하지 않은 형상이 나오는 것을 감안하고 스윕 형상을 만들거나, 선형 보외법을 사용하는 것이다. 선형 보외법을 사용하면 언제나 볼록 형상이지만, 정확한 표현이 불가능하다.

      - 또 다른 방법으로 연속 충돌 검출(Continuous Collision Detection, CCD)이 존재한다. 전 프레임과 현 프레임의 위치와 방향을 선형 보간해 가장 이른 충돌 시간을 찾는 것이다.

  - 모든 쌍을 검사해야 하므로 O(n<sup>2</sup>)의 복잡도를 갖기에 공간 해시, 공간 분할, 계층적 경계 볼륨 기법 등을 사용해 최적화를 한다.  
    - 공간 해시는 다음 사이트를 참고하자. <http://hhoppe.com/perfecthash.pdf>

    - 충돌체가 완만하게 움직이고 있다면 시간적 일관성을 이용할 수 있다. 완만하게 움직인다면 여러 프레임이 지나도 위치와 방향이 크게 변하지 않으므로, 정보를 계산한 뒤 여러 프레임 동안 재사용하는 것이다.

    - 공간 분할은 렌더링에서 사용하는 장면 그래프를 참고하자.

    - 계층적 경계 볼륨 : 간단한 검사(AABB)에서 시작해서 복잡한 검사(개별적 충돌 단위)를 하는 방식이다. 멀리 있는 물체는 간단한 검사에서 모두 걸러지므로, 효율적으로 테스트할 수 있다.
      - sweep and prune 알고리즘은 충돌체들의 AABB에서 각 좌표축 방향으로 최대, 최소 값을 구하고 정렬된 리스트를 탐색해 교차하는 AABB를 찾는 방식이다. 대부분의 엔진에서 간단한 검사를 할 때 사용한다.

  - 충돌 검출 시스템은 레이 캐스트, 형상 캐스트 등의 충돌 질의를 지원해야 한다.
    - 레이 캐스트 : 시작점과 끝점이 있는 선분을 충돌체와 테스트해 교차하는 충돌체가 있으면 접촉 지점을 반환한다. 보통 시작점 *p<sub>0</sub>* 와 델타 벡터 *d* 로 정의되며 선분 위에 있는 모든 점은 *p* (t) = *p<sub>0</sub>* + t *d*라는 매개변수 방정식으로 나타낸다.

    - 형상 캐스트는 레이캐스트와 유사하나, 점이 아닌 임의의 볼록 형상으로 테스트하는 것이다.

    - 팬텀(표준 용어는 아니고 하복에서 쓰이는 용어)은 벡터 *d* 가 0인 구 캐스트와 유사하다.

  - 특정 종류 사이에 충돌을 키고 끌 수 있어야 한다. (물은 통과할 수 있는 것이 대표적인 예시이다.) 이를 충돌 필터링을 통해 조작한다.
    - 보통 물체들을 범주로 나눈 후, 테이블을 활용해 다른 물체와 충돌 가능한지 찾는 방법을 사용한다.

    - 다른 방법으로는 검출될 때마다 콜백 함수를 호출한 후 콜백에서 충돌 정보를 보고 필터링하는 방식이 있다.

  - 충돌 시 소리, 효과나 마찰 계수 같은 물리 속성을 지정할 필요가 있다. 이를 렌더링의 머터리얼과 비슷한 형태로 표현하며 충돌 머터리얼이라고 한다.
